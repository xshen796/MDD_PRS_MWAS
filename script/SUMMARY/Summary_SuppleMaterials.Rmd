---
title: "EWAS of MDD PRS - Supplementary Materials"
author: "X Shen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: cerulean
    code_folding: hide
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
library(knitr)                                           # For md
library(rmarkdown)                                       # For md
library(dplyr)                                           # Data management
library(ggplot2)                                         # Graph
library(ggrepel)                                         # Graph
library(ggpubr)                                          # Graph
library(patchwork)                                       # Graph
library(igraph)                                          # Circular connectivity graph
library(ggraph)                                          # Circular connectivity graph
library(here)                                            # Data loading
library(data.table)                                      # Data loading
library(tidyr)                                           # Data management
library(tibble)                                          # Data management
library(IlluminaHumanMethylationEPICanno.ilm10b2.hg19)   # Data management
library(hrbrthemes)                                      # Graph
library(superheat)                                       # Graph
library(kableExtra)                                      # Table
library(missMethyl)                                      # Extra pathway analysis
library(pbapply)                                         # Process control

# My own functions
source(here::here('MR_meth_MDD/FUNs/manhattan_plot_XShen.R')) # EWAS manhattan plot
source(here::here('MR_meth_MDD/FUNs/circular_graph_mr.R'))    # circular connectivity graph

# Render from MR_meth_MDD folder
```
  
  
------------------------------------------------------------------------

------------------------------------------------------------------------

## EWAS for MDD PRS

------------------------------------------------------------------------

### Methods

#### Subjects

From Generation Scotland,

-   Wave 1: N = 4977

-   Wave 2: N = 4312

    
#### DNA methylation data and technical covariates

Processed by Rosie, using EPIC array. M values.

Relatedness controlled for by regressing against GRM. Other regressors include batch and cell proportion.

#### Additional covariates

Ever smoke, pack years, age, sex and 20 methylation PCs.

  
#### Pipeline

From Mark, [wiki](https://www.wiki.ed.ac.uk/pages/viewpage.action?spaceKey=Psychiatry&title=STRADL+EWAS+pipeline).

------------------------------------------------------------------------

### EWAS Results{.tabset}

```{r Load summary stats - EWAS, echo=FALSE, warning=FALSE, message=FALSE,cache=T}
anno <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b2.hg19)
ref.tomerge <- anno %>% as.data.frame %>%
  dplyr::select(ID=Name, CHR=chr, MAPINFO=pos,ucsc_gene=UCSC_RefGene_Name,
         Islands_Name,Relation_to_Island)

ls.pt=c('5e_08','0.000001','0.0001','0.001','0.01','0.05','0.1','0.5','1')
for (pt in ls.pt){
    # Load data
    f.path=paste0('MR_meth_MDD/result/EWAS_MDDprs_Shen/archiv/MDDprs_ewas_meta/MDDprs_pT',pt,'_meta/mddprs_pT',pt,'_meta_RosieData.toptable.txt1.tbl')
    ewasResults=read.delim(here::here(f.path),sep='\t',header=T,stringsAsFactors=F) %>%
      mutate(p.adj = p.adjust(P.value,method='bonferroni')) 
    colnames(ewasResults)[1]='CpG'
    # Add annotations
    ewasResults=merge(ewasResults,ref.tomerge,by.x='CpG',by.y='ID',all.x=T)
    # Reformat data for printing
    qman.dat=ewasResults
    qman.dat$CHR=gsub('chr','',qman.dat$CHR)
    qman.dat$CHR=as.numeric(qman.dat$CHR)
    qman.dat=filter(qman.dat,!is.na(CpG),!is.na(CHR),!is.na(MAPINFO),!is.na(P.value))
    # Store data
    expre=paste0('fig.dat.GS.pT.',pt,'=qman.dat')
    eval(parse(text=expre))
    # Make manhattan plot (save as tiff files and store in R environment)
    tmp.path = paste0('MR_meth_MDD/Figs/GS_EWAS_pplot_',pt,'.png')
    tmp.fig = m_plot(dat=qman.dat,
                    chr="CHR", bp="MAPINFO", snp="CpG", p="P.value",
                    add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,120),
                    outputpath=here::here(tmp.path))
    expre=paste0('fig.GSewas.',pt,'=tmp.fig')
    eval(parse(text=expre))  
}
```

#### PRS pT=5e-8

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
# fig.GSewas.5e_08: recall the function to put this figure in the main text
m_plot(dat=fig.dat.GS.pT.5e_08,
                    chr="CHR", bp="MAPINFO", snp="CpG", p="P.value",
                    add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,120),
                    outputpath=here::here('MR_meth_MDD/Figs/GS_EWAS_pplot_5e_08.png'))
```

#### PRS pT=5e-8 no MHC region

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
   qman.dat=filter(fig.dat.GS.pT.5e_08,(CHR!=6)|((MAPINFO<25000000)|(MAPINFO>35000000)))
   fig.GSewas.5e_08.noMHC = m_plot(dat=qman.dat,
          chr="CHR", bp="MAPINFO", snp="CpG", p="P.value",
          add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,20),
          outputpath=here::here('MR_meth_MDD/Figs/GS_EWAS_pplot_5e_08_noMHC.png'))
   fig.GSewas.5e_08.noMHC
```


#### PRS pT=0.000001

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
  fig.GSewas.0.000001
```

#### PRS pT=0.0001

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
  fig.GSewas.0.0001
```

#### PRS pT=0.01

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
  fig.GSewas.0.01
```

#### PRS pT=0.1

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
  fig.GSewas.0.1
```

#### PRS pT=1

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
   fig.GSewas.1
```

#### Summary table
```{r}
   
```


### Number of significant CpGs associated with PRS

```{r numer of sig CpGs for all PRS, echo=FALSE,warning=F,message=FALSE,fig.width=6,fig.height=5}

ls.pt=c('5e_08','0.000001','0.0001','0.001','0.01','0.05','0.1','0.5','1')

for (pt in ls.pt){
    ewasResults=get(paste0('fig.dat.GS.pT.',pt))
    
    ewasResults$p.fdr=p.adjust(ewasResults$P.value,method='fdr')
    ewasResults$p.bonferroni=p.adjust(ewasResults$P.value,method='bonferroni')
                 
    tmp.count=data.frame(N5e_08=sum(ewasResults$P.value<5e-8,na.rm=T),
                         N5_e06=sum(ewasResults$P.value<5e-6,na.rm=T),
                         Nfdr=sum(ewasResults$p.fdr<0.05,na.rm=T),
                         Nbonferroni=sum(ewasResults$p.bonferroni<0.05,na.rm=T))
    if(pt==ls.pt[1]){sig.count=tmp.count}else{sig.count=rbind(sig.count,tmp.count)}

}
sig.count$MDDprs=factor(ls.pt,levels=rev(ls.pt))

graph.dat=reshape2::melt(sig.count,id.vars='MDDprs')
graph.dat$variable=gsub('N5e_08','p<5e-08',graph.dat$variable)
graph.dat$variable=gsub('N5e_06','p<5e-06',graph.dat$variable)
graph.dat$variable=gsub('Nfdr','pFDR<0.05',graph.dat$variable)
graph.dat$variable=gsub('Nbonferroni','pBonferroni<0.05',graph.dat$variable)
colnames(graph.dat)=c('MDDprs','Type','No')

fig=ggplot(data=graph.dat, aes(x=MDDprs, y=No, group=Type)) +
  geom_line(aes(color=Type))+
  geom_point(aes(color=Type))+
  theme(axis.text.x = element_text(angle = 90),
  text = element_text(size=10))+
  xlab('MDDprs pT')+
  ylab('Number of significant CpGs')+
  labs(group = "Threshold for significance")

fig

ggsave(plot = fig,filename = here::here('MR_meth_MDD/Figs/No_sig_CpG_GS.png'),
       width = 12, height = 9, 
       units = 'cm', dpi = 300)

```

  
### CpGs to nearest genome-wide significant locus

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.width=8,fig.height=5}
### Data prep
# MDD.gwas.hits = fread('/exports/igmm/eddie/GenScotDepression/shen/bakup.dat/summstats/23andme_PGCNoGS_UKB_Aug8_FinalGCldsc_3cohort1.meta.forPRSice') %>%
#   filter(.,P<5e-8) 
# MDD.gwas.hits = MDD.gwas.hits[!grepl('hap',MDD.gwas.hits$CHR),] %>%
#   mutate(CHR=as.numeric(CHR))
# 
# ewas.pTwgsig = fig.dat.pT.5e_08 %>% 
#   mutate(p.adj = p.adjust(P.value,method='bonferroni')) 
# 
# dis_nearest_gwashit <- function(tmp.gwas,tmp.targetloc){
#   target.chr=as.numeric(tmp.targetloc['CHR'])
#   target.bp=as.numeric(tmp.targetloc['MAPINFO'])
#   
#   tmp.block.gwas = filter(tmp.gwas,CHR==target.chr)
#   if (nrow(tmp.block.gwas)==0){bp.distance=NA}else{
#   bp.distance = min(abs(tmp.block.gwas$BP-target.bp),na.rm=T)    
#   }
# }
# 
# tmp.distance.toadd = pbapply(ewas.pTwgsig, MARGIN = 1,
#                            FUN=dis_nearest_gwashit,tmp.gwas=MDD.gwas.hits) %>%
#   unlist
# 
# ewas.pTwgsig$distance_to_nearest_gwashit = tmp.distance.toadd

# save(ewas.pTwgsig,file='result/EWAS_MDDprs_fromKathryn/ewas.distance.RData')
load(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/ewas.distance.RData'))

ewas.pTwgsig = ewas.pTwgsig %>%
  mutate(EWAS.sig = ifelse(p.adj<0.05,'yes','no'))
 
fig.distance_to_nearest_gwasHit = 
  ggplot(ewas.pTwgsig, aes(x=EWAS.sig, y=distance_to_nearest_gwashit, fill=EWAS.sig)) +
  geom_violin() +
  theme(
    legend.position="none",
    plot.title = element_text(size=11)
  )+
  ylim(0,1e+6)+
  xlab('Significant CpG in EWAS') +
  ylab('Distance to the nearest GWAS loci (p<5e-8)')

# Print 
fig.distance_to_nearest_gwasHit
# Save
ggsave(file=here::here('MR_meth_MDD/Figs/MainText/Distance_to_nearest_gwasHit.png'),
       plot=fig.distance_to_nearest_gwasHit,
       dpi = 300, width = 6, height = 4, units = 'in')

# Calculate 95% CI
CI95.sig = 
  quantile(ewas.pTwgsig$distance_to_nearest_gwashit[ewas.pTwgsig$EWAS.sig=='yes'],
           c(0.025,0.975),na.rm=T)
CI95.nonsig = 
  quantile(ewas.pTwgsig$distance_to_nearest_gwashit[ewas.pTwgsig$EWAS.sig=='no'],
           c(0.025,0.975),na.rm=T)


```

95% CI for distance to the nearest MDD risk locus:

-   Significant CpG:  `r CI95.sig[1]`-`r CI95.sig[2]`
-   Non-significant CpG: `r CI95.nonsig[1]`-`r CI95.nonsig[2]`

### Gene annotation

```{r,echo=F,warning=F,message=F}
## All CpG
# Most frequently identified genes
ewas.sig = fig.dat.GS.pT.5e_08 %>%
  filter(.,p.adj<0.05)

## No MHC region
```


### Pathway analysis{.tabset}

```{r load pathway data,warning=FALSE,message=FALSE}
GO.result = read.table(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/meta-pgrs-mdd/mdd_SNPCH_prs_5e_08/mdd_SNPCH_prs_5e_08.GO.txt'),header=T,stringsAsFactors=F)
KEGG.result = read.table(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/meta-pgrs-mdd/mdd_SNPCH_prs_5e_08/mdd_SNPCH_prs_5e_08.KEGG.txt'),header=T,stringsAsFactors=F)

GO.result.sig=GO.result[order(GO.result$FDR,decreasing=F),] %>%
  filter(.,FDR<0.05)
KEGG.result.sig=KEGG.result[order(KEGG.result$FDR,decreasing=F),] %>%
  filter(.,FDR<0.05)

# pathway analysis for non-MHC probes
pathway.dat=fig.dat.GS.pT.5e_08 %>%
      mutate(is.MHC = if_else(MAPINFO>25000000&MAPINFO<35000000&CHR==6,'Yes','No')) %>%
      filter(.,is.MHC == 'No')
GO.result.sig_noMHC <- 
  gometh(sig.cpg=pathway.dat$CpG[pathway.dat$p.adj<0.05], 
         all.cpg=pathway.dat$CpG, collection="GO",
              array.type = "EPIC") %>%
  .[order(.$P.DE,decreasing=F),] 

KEGG.result.sig_noMHC <- 
  gometh(sig.cpg=pathway.dat$CpG[pathway.dat$p.adj<0.05], 
         all.cpg=pathway.dat$CpG, collection="KEGG",
              array.type = "EPIC") %>%
  .[order(.$FDR,decreasing=F),] 

```

#### GO results - all CpG

```{r, echo=F,warning=FALSE,message=FALSE}
GO.result.sig[1:20,] %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

#### KEGG results - all CpG

```{r, echo=F,warning=FALSE,message=FALSE}
KEGG.result.sig[1:20,] %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

#### GO results - no MHC

```{r, echo=F,warning=FALSE,message=FALSE}
GO.result.sig_noMHC[1:20,] %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

#### KEGG results - no MHC

```{r, echo=F,warning=FALSE,message=FALSE}
KEGG.result.sig_noMHC[1:20,] %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

### Summary of EWAS for MDD PRS pT = 5e-8

```{r,warning=FALSE,message=FALSE,fig.width=8,fig.height=5}
# 1. No. of significant CpGs in the MHC region
ewas.pTwgsig = ewas.pTwgsig %>%
  mutate(is.MHC = if_else(MAPINFO>25000000&MAPINFO<35000000&CHR==6,'Yes','No'))
no.MHC.sig = table(ewas.pTwgsig$is.MHC[ewas.pTwgsig$p.adj<0.05])
no.MHC.sig

# 2. Top 10 CpGs
top.10.sig = ewas.pTwgsig %>%
  filter(.,p.adj<0.05) %>%
  .[order(.$P.value,decreasing = F),] 
top.10.sig[1:10,] %>%
    kbl() %>%
  kable_material(c("striped", "hover"))
top10.max.p=max(top.10.sig$p.adj[1:10])

# 3. significant CpGs outside of the MHC region
top.10.sig.noMHC = ewas.pTwgsig %>%
  filter(.,p.adj<0.05) %>%
  filter(.,is.MHC=='No') %>%
  .[order(.$P.value,decreasing = F),] 
summary(top.10.sig.noMHC$p.adj)

# 4. Top 10 non-MHC CpGs
top.10.sig.noMHC[1:10,] %>%
    kbl() %>%
  kable_material(c("striped", "hover"))
top.10.sig.noMHC.sCHR=top.10.sig.noMHC[1:10,] %>%
  .[order(.$CHR),]
top10.noMHC.max.p=max(top.10.sig.noMHC$p.adj[1:10])

```


------------------------------------------------------------------------
  
------------------------------------------------------------------------

## EWAS replication in LBC

### Methods

#### Subjects

-   From LBC: ***N = 1330***
    
#### Data

-   DNA methylation: Processed by Riccardo. 450k array. M-values.

-   Genetic: HRCv1.1 imputed data 

-   LD reference: 1000G CEU sample, phase 3, hg19 genome build

#### Covariates

Smoking status, age, sex, 20 methylation PCs, and cell proportions.
  
#### Pipeline

From Mark, [wiki](https://www.wiki.ed.ac.uk/pages/viewpage.action?spaceKey=Psychiatry&title=STRADL+EWAS+pipeline).

Local copy (adapted to LBC data): /exports/igmm/eddie/GenScotDepression/shen/Tools/ewas_pipeline/

### Results

#### Manhattan Plot

```{r Load LBC ewas results,echo=FALSE,message=FALSE,fig.width=13,fig.height=7}

ewasResults.lbc=read.delim(here::here('MR_meth_MDD/result/EWAS_MDDprs_LBC/MDDprs_Pt_gwsig_ewas.toptable.txt'),sep='\t',header=T,stringsAsFactors=F)
fig.dat = ewasResults.lbc %>%
  mutate(CHR=gsub('chr','',.$CHR)) %>%
  mutate(CHR=as.numeric(CHR)) %>%
  mutate(CpG=ID)

m_plot(dat=fig.dat,chr="CHR", bp="MAPINFO", snp="ID", p="P.Value",tophits.bpwindow=250000,
       outputpath=here::here('MR_meth_MDD/Figs/MainText/LBC_EWAS_pplot_5e_08.png'),
       add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,10))

```

#### Correlation of beta for significant CpGs found in GS

```{r,echo=FALSE,warning=FALSE,fig.width=7,fig.height=4.6,fig.align='center'}
GS.ewas = fig.dat.GS.pT.5e_08
LBC.ewas = ewasResults.lbc

GS.sig = mutate(GS.ewas,p.adj=p.adjust(P.value,method='bonferroni')) %>%
  select(CpG=CpG,GS.beta=Effect,GS.std=StdErr,GS.p=P.value,GS.p.adj=p.adj) %>%
  mutate(GS.beta_se=GS.beta/GS.std)
LBC.match = LBC.ewas[LBC.ewas$ID %in% GS.sig$CpG,] %>%
  select(ID,beta,se,P.Value) %>%
  dplyr::rename(CpG=ID,LBC.beta=beta,LBC.se=se,LBC.p=P.Value) %>%
  mutate(LBC.beta_se=LBC.beta/LBC.se)

combined.test = merge(LBC.match,GS.sig,by='CpG') %>%
  merge(.,ref.tomerge,by.x='CpG',by.y='ID',all.x=T) %>%
  mutate(is.MHC = if_else(MAPINFO>25000000&MAPINFO<35000000&CHR=='chr6','Yes','No')) %>%
  mutate(is.MHC = factor(is.MHC,levels=c('No','Yes'))) %>%
  filter(GS.p.adj<0.05)
combined.test.noMHC = filter(combined.test,is.MHC=='No')

r.beta.all = round(cor.test(combined.test$LBC.beta_se,combined.test$GS.beta_se)$estimate,3)
r.beta.noMHC = round(cor.test(combined.test.noMHC$LBC.beta_se,combined.test.noMHC$GS.beta_se)$estimate,3)

fig=
  ggplot(combined.test, aes(x=GS.beta_se, y=LBC.beta_se,color=is.MHC)) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2, alpha = 0.5) +
  theme(
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  geom_smooth(method=lm , color="dark grey", se=TRUE)+
  ylab('LBC Beta/SE')+
  xlab('GS Beta/SE')+
  annotate(geom="text",label=paste0('r (all) = ',r.beta.all), x=12, y=-3,hjust = 0)+
  annotate(geom="text",label=paste0('r (noMHC) = ',r.beta.noMHC), x=12, y=-3.5,hjust = 0) +
  labs(color = "In MHC region?")

fig

ggsave(file=here::here('MR_meth_MDD/Figs/MainText/Replication_beta_correlation_GS_LBC.png'),
       plot=fig.distance_to_nearest_gwasHit,
       dpi = 300, width = 6, height = 4, units = 'in')
```

#### Summry of replication analysis: on CpGs significant in GS (nCpG = 620)

-   Correlation between betas in GS and LBC for all CpGs:  r = `r r.beta.all`

-   Correlation between betas in GS and LBC for CpGs not in MHC region:  r = `r r.beta.noMHC`

-   Betas remained in the same direction in LBC:  `r round(sum(combined.test$LBC.beta/combined.test$GS.beta>0)/nrow(combined.test),3)*100`%

-   CpGs nominally significant in LBC: `r round(sum(combined.test$LBC.p<0.05)/nrow(combined.test),3)*100`%

#### Replication EWAS for other PRS (other pT)

Figures saved as: MR_meth_MDD/Figs/LBC_EWAS_pplot*

```{r ALSPAC PRS LBC, echo=FALSE, warning=FALSE, cache=F,message=F}
ls.pt=c('5e.08','1e.06','0.0001','0.001','0.01','0.05','0.1','0.5','1')
for (pt in ls.pt){
    # Load data
    f.path=paste0('MR_meth_MDD/result/EWAS_MDDprs_LBC/MDDprs_Pt_',pt,'_ewas.toptable.txt')
    ewasResults=read.delim(here::here(f.path),sep='\t',header=T,stringsAsFactors=F)
    colnames(ewasResults)[1]='CpG'
    # Reformat data for printing
    qman.dat=ewasResults
    qman.dat$CHR=gsub('chr','',qman.dat$CHR)
    qman.dat$CHR=as.numeric(qman.dat$CHR)
    qman.dat=filter(qman.dat,!is.na(CpG),!is.na(CHR),!is.na(MAPINFO),!is.na(P.Value))
    # Store data
    expre=paste0('fig.dat.LBC.pT.',pt,'=qman.dat')
    eval(parse(text=expre))
    # Make manhattan plot (save as tiff files and store in R environment)
    tmp.path = paste0('MR_meth_MDD/Figs/LBC_EWAS_pplot_',pt,'.png')
    tmp.fig = m_plot(dat=qman.dat,
                    chr="CHR", bp="MAPINFO", snp="CpG", p="P.Value",
                    add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,15),
                    outputpath=here::here(tmp.path))
    expre=paste0('fig.LBCewas.',pt,'=tmp.fig')
    eval(parse(text=expre))  
}
```

#### Number of significant CpGs associated with PRS

```{r numer of sig CpGs for all PRS - LBC, echo=FALSE,warning=F,message=FALSE,fig.width=6,fig.height=5}
ls.pt=c('5e.08','1e.06','0.0001','0.001','0.01','0.05','0.1','0.5','1')
for (pt in ls.pt){
    ewasResults=get(paste0('fig.dat.LBC.pT.',pt))
    
    ewasResults$p.fdr=p.adjust(ewasResults$P.Value,method='fdr')
    ewasResults$p.bonferroni=p.adjust(ewasResults$P.Value,method='bonferroni')
                 
    tmp.count=data.frame(N5e_08=sum(ewasResults$P.Value<5e-8,na.rm=T),
                         N5_e06=sum(ewasResults$P.Value<5e-6,na.rm=T),
                         Nfdr=sum(ewasResults$p.fdr<0.05,na.rm=T),
                         Nbonferroni=sum(ewasResults$p.bonferroni<0.05,na.rm=T))
    if(pt==ls.pt[1]){sig.count=tmp.count}else{sig.count=rbind(sig.count,tmp.count)}

}
sig.count$MDDprs=factor(ls.pt,levels=rev(ls.pt))

graph.dat=reshape2::melt(sig.count,id.vars='MDDprs')
graph.dat$variable=gsub('N5e_08','p<5e-08',graph.dat$variable)
graph.dat$variable=gsub('N5e_06','p<5e-06',graph.dat$variable)
graph.dat$variable=gsub('Nfdr','pFDR<0.05',graph.dat$variable)
graph.dat$variable=gsub('Nbonferroni','pBonferroni<0.05',graph.dat$variable)
colnames(graph.dat)=c('MDDprs','Type','No')

fig=ggplot(data=graph.dat, aes(x=MDDprs, y=No, group=Type)) +
  geom_line(aes(color=Type))+
  geom_point(aes(color=Type))+
  theme(axis.text.x = element_text(angle = 90),
  text = element_text(size=10))+
  xlab('MDDprs pT')+
  ylab('Number of significant CpGs')+
  labs(group = "Threshold for significance")

fig

ggsave(plot = fig,filename = here::here('MR_meth_MDD/Figs/No_sig_CpG_LBC.png'),
       width = 12, height = 9, 
       units = 'cm', dpi = 300)

```

------------------------------------------------------------------------
  
------------------------------------------------------------------------

## EWAS replication in ALSPAC

### Methods

#### Subjects

-   From LBC: ***N = 719***
    
#### Data

-   DNA methylation: Processed by Riccardo. 450k array. M-values.

-   Genetic: HRCv1.1 imputed data 

-   LD reference: 1000G CEU sample, phase 3, hg19 genome build

#### Covariates

Smoking status, age, sex, technical covariates, and cell proportions.
  
#### Pipeline

From Doretta, [ref](https://www.wiki.ed.ac.uk/pages/viewpage.action?spaceKey=Psychiatry&title=STRADL+EWAS+pipeline).

### Results

#### Manhattan Plot 

```{r Load ALSPAC ewas results,echo=FALSE,message=FALSE,fig.width=13,fig.height=7}

load(here::here('MR_meth_MDD/result/EWAS_MDDprs_ALSPAC/MDD3_m_5e08_std_age,mum_ever_smoke,mpc1,mpc2,mpc3,mpc4,mpc5,mpc6,mpc7,mpc8,mpc9,mpc10_houseman_2021-02-12.Rdata'))
fig.dat = ewas_res %>%
  merge(.,ref.tomerge,by.x='probeID',by.y='ID',all.x=T) %>%
  mutate(CHR=gsub('chr','',.$CHR)) %>%
  mutate(CHR=as.numeric(CHR)) %>%
  mutate(CpG=probeID)

m_plot(dat=fig.dat,chr="CHR", bp="MAPINFO", snp="CpG", p="P_VAL",tophits.bpwindow=250000,
       outputpath=here::here('MR_meth_MDD/Figs/MainText/ALSPAC_EWAS_pplot_5e_08.png'),
       add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,10))

```

#### Correlation of beta for significant CpGs found in GS 

```{r,echo=FALSE,warning=FALSE,fig.width=7,fig.height=4.6,fig.align='center'}
GS.ewas = fig.dat.GS.pT.5e_08
alspac.m.ewas = ewas_res %>%
  mutate(probeID=as.character(probeID))

alspac.match = alspac.m.ewas[alspac.m.ewas$probeID %in% GS.sig$CpG,] %>%
  select(CpG=probeID,alspac.beta=BETA,alspac.se=SE,alspac.p=P_VAL) %>%
  mutate(alspac.beta_se=alspac.beta/alspac.se)

combined.test = merge(alspac.match,GS.sig,by='CpG') %>%
  merge(.,ref.tomerge,by.x='CpG',by.y='ID',all.x=T) %>%
  mutate(is.MHC = if_else(MAPINFO>25000000&MAPINFO<35000000&CHR=='chr6','Yes','No')) %>%
  mutate(is.MHC = factor(is.MHC,levels=c('No','Yes'))) %>%
  filter(GS.p.adj<0.05)
combined.test.noMHC = filter(combined.test,is.MHC=='No')

r.beta.all = round(cor.test(combined.test$alspac.beta_se,combined.test$GS.beta_se)$estimate,3)
r.beta.noMHC = round(cor.test(combined.test.noMHC$alspac.beta_se,combined.test.noMHC$GS.beta_se)$estimate,3)

fig=
  ggplot(combined.test, aes(x=GS.beta_se, y=alspac.beta_se,color=is.MHC)) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2, alpha = 0.5) +
  theme(
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  geom_smooth(method=lm , color="dark grey", se=TRUE)+
  ylab('ALSPAC Beta/SE')+
  xlab('GS Beta/SE')+
  annotate(geom="text",label=paste0('r (all) = ',r.beta.all), x=12, y=-3,hjust = 0)+
  annotate(geom="text",label=paste0('r (noMHC) = ',r.beta.noMHC), x=12, y=-3.8,hjust = 0) +
  labs(color = "In MHC region?")

fig

ggsave(file=here::here('MR_meth_MDD/Figs/MainText/Replication_beta_correlation.png'),
       plot=fig.distance_to_nearest_gwasHit,
       dpi = 300, width = 6, height = 4, units = 'in')

load(here::here('MR_meth_MDD/result/EWAS_MDDprs_ALSPAC/MDD3_k_5e08_std_sex,age,child_smoke,pc1,pc2,pc3,pc4,pc5,pc6,pc7,pc8,pc9,pc10_houseman_2021-02-12.Rdata'))

```

#### Summry of replication analysis: on CpGs significant in GS (nCpG = 620)

-   Correlation between betas in GS and LBC for all CpGs:  r = `r r.beta.all`

-   Correlation between betas in GS and LBC for CpGs not in MHC region:  r = `r r.beta.noMHC`

-   Betas remained in the same direction in LBC:  `r round(sum(combined.test$LBC.beta/combined.test$GS.beta>0)/nrow(combined.test),3)*100`%

-   CpGs nominally significant in LBC: `r round(sum(combined.test$LBC.p<0.05)/nrow(combined.test),3)*100`%

#### Replication EWAS for other PRS (other pT)

Figures saved as: MR_meth_MDD/Figs/LBC_EWAS_pplot*

```{r ALSPAC PRS EWAS, echo=FALSE, warning=FALSE, cache=F,message=F}
ls.pt=c('5e08','1e06','1e04','1e03','1e02','5e02','1e01','5e01','1')
for (pt in ls.pt){
    # Load data
    f.path=paste0('MR_meth_MDD/result/EWAS_MDDprs_ALSPAC/MDD3_m_',pt,'_std_age,mum_ever_smoke,mpc1,mpc2,mpc3,mpc4,mpc5,mpc6,mpc7,mpc8,mpc9,mpc10_houseman_2021-02-12.Rdata')
    load(here::here(f.path))
    ewasResults=ewas_res 
    colnames(ewasResults)[1]='CpG'
    # Reformat data for printing
    qman.dat=ewasResults %>% 
       merge(.,ref.tomerge,by.x='CpG',by.y='ID',all.x=T) %>%
       mutate(CHR=gsub('chr','',CHR)) %>%
       mutate(CHR=as.numeric(CHR)) %>%
       mutate(CpG=as.character(CpG)) %>%
       mutate(P.Value=P_VAL)

    qman.dat=filter(qman.dat,!is.na(CpG),!is.na(CHR),!is.na(MAPINFO),!is.na(P.Value))
    # Store data
    expre=paste0('fig.dat.LBC.pT.',pt,'=qman.dat')
    eval(parse(text=expre))
    # Make manhattan plot (save as tiff files and store in R environment)
    tmp.path = paste0('MR_meth_MDD/Figs/ALSPAC_EWAS_pplot_',pt,'.png')
    tmp.fig = m_plot(dat=qman.dat,
                    chr="CHR", bp="MAPINFO", snp="CpG", p="P.Value",
                    add_category_name=F,fig_size=c(22,13),tophits_annot=T,y_lim=c(0,15),
                    outputpath=here::here(tmp.path))
    expre=paste0('fig.ALSPACewas.',pt,'=tmp.fig')
    eval(parse(text=expre))  
}
```

#### Number of significant CpGs associated with PRS

```{r numer of sig CpGs for all PRS - ALSPAC, echo=FALSE,warning=F,message=FALSE,fig.width=6,fig.height=5}
ls.pt=c('5e08','1e06','1e04','1e03','1e02','5e02','1e01','5e01','1')
for (pt in ls.pt){
    ewasResults=get(paste0('fig.dat.LBC.pT.',pt))
    
    ewasResults$p.fdr=p.adjust(ewasResults$P.Value,method='fdr')
    ewasResults$p.bonferroni=p.adjust(ewasResults$P.Value,method='bonferroni')
                 
    tmp.count=data.frame(N5e_08=sum(ewasResults$P.Value<5e-8,na.rm=T),
                         N5_e06=sum(ewasResults$P.Value<5e-6,na.rm=T),
                         Nfdr=sum(ewasResults$p.fdr<0.05,na.rm=T),
                         Nbonferroni=sum(ewasResults$p.bonferroni<0.05,na.rm=T))
    if(pt==ls.pt[1]){sig.count=tmp.count}else{sig.count=rbind(sig.count,tmp.count)}

}
sig.count$MDDprs=factor(ls.pt,levels=rev(ls.pt))

graph.dat=reshape2::melt(sig.count,id.vars='MDDprs')
graph.dat$variable=gsub('N5e_08','p<5e-08',graph.dat$variable)
graph.dat$variable=gsub('N5e_06','p<5e-06',graph.dat$variable)
graph.dat$variable=gsub('Nfdr','pFDR<0.05',graph.dat$variable)
graph.dat$variable=gsub('Nbonferroni','pBonferroni<0.05',graph.dat$variable)
colnames(graph.dat)=c('MDDprs','Type','No')

fig=ggplot(data=graph.dat, aes(x=MDDprs, y=No, group=Type)) +
  geom_line(aes(color=Type))+
  geom_point(aes(color=Type))+
  theme(axis.text.x = element_text(angle = 90),
  text = element_text(size=10))+
  xlab('MDDprs pT')+
  ylab('Number of significant CpGs')+
  labs(group = "Threshold for significance")

fig

ggsave(plot = fig,filename = here::here('MR_meth_MDD/Figs/No_sig_CpG_ALSPAC.png'),
       width = 12, height = 9, 
       units = 'cm', dpi = 300)

```


------------------------------------------------------------------------

## SNP to CpG mapping

------------------------------------------------------------------------

```{r, echo=FALSE,warning=FALSE,fig.width=10,fig.height=8,fig.align='center'}

load(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/cpg_snp_mapping_pNbeta.RData'))

p.mat = p.mat %>% column_to_rownames(var="CpG") 

# Select independent CpGs
ls.cpg = list.files(here::here('MR_meth_MDD/data/mQTL/mQTL_forMR/')) %>%
  gsub('mQTL.','',.) %>%
  gsub('.rds','',.)

# Reorder CpG by CHR
ls.CpG = ls.CpG %>%
  mutate(.,CHR=gsub('chr','',CHR)) %>%
  mutate(.,CHR=as.numeric(CHR)) %>%
  .[order(.$CHR,decreasing = F),] %>%
  mutate(ID=as.character(ID)) %>%
  .[.$ID %in% ls.cpg,]

# Reorder SNP by CHR
colnames(ls.SNP.102)=c('CHR','BP','RSID')
ls.SNP.102 = ls.SNP.102 %>%
  mutate(.,CHR=gsub('chr','',CHR)) %>%
  mutate(.,CHR=as.numeric(CHR)) %>%
  .[order(.$CHR,decreasing = F),] %>%
  mutate(RSID=as.character(RSID)) %>%
  .[.$CHR %in% ls.CpG$CHR,]

# Reorder p.mat and reduce size
colnames(p.mat)=strsplit(colnames(p.mat),split = '_') %>% unlist %>% .[grep('^rs',.)]
p.mat[p.mat==0]=1e-320  # Recover extremely low p-values to system threshold
p.mat[p.mat>0.05/102]=NA
p.mat.new = -log10(p.mat) %>%
  .[ls.CpG$ID,] %>%
  .[,ls.SNP.102$RSID]


ls.indep.cpg = ls.CpG[ls.CpG$ID %in% ls.cpg,]
p.mat.new=p.mat.new[ls.indep.cpg$ID,]



# Heatmap
set.seed(1234)
png(here::here('MR_meth_MDD/Figs/MainText/SNP_to_CpG_mapping.png'), height = 400, width = 700,res = 300)
superheat(p.mat.new,
          # row title
          row.title = "CpG",
          row.title.size = 6,
          # col title
          column.title = "SNP",
          column.title.size = 6,
          # scale the matrix columns
          scale = F,
          heat.col.scheme = "red",
          heat.na.col = "white",
          # cluster by gears
          membership.rows = paste('CHR',ls.indep.cpg$CHR),
          membership.cols = paste('CHR',ls.SNP.102$CHR),
          # Text
          bottom.label.text.angle = 90,
          left.label.text.size = 4,
          bottom.label.text.size = 4)
dev.off()
superheat(p.mat.new,
          # row title
          row.title = "CpG",
          row.title.size = 6,
          # col title
          column.title = "SNP",
          column.title.size = 6,
          # scale the matrix columns
          scale = F,
          heat.col.scheme = "red",
          heat.na.col = "white",
          # cluster by gears
          membership.rows = paste('CHR',ls.indep.cpg$CHR),
          membership.cols = paste('CHR',ls.SNP.102$CHR),
          # Text
          bottom.label.text.angle = 90,
          left.label.text.size = 4,
          bottom.label.text.size = 4)

```

```{r}
##### Calculate SNP-CpG distance
# Define function
cal_distance <- function(tmp.ids,ref.anno.snp,ref.anno.cpg){
  snp.id = as.character(tmp.ids['SNP'])
  cpg.id = as.character(tmp.ids['CpG'])
  
  chr.snp = ref.anno.snp$CHR[ref.anno.snp$RSID==snp.id]
  chr.cpg = ref.anno.cpg$CHR[ref.anno.cpg$ID==cpg.id]
  bp.snp = ref.anno.snp$BP[ref.anno.snp$RSID==snp.id]
  bp.cpg = ref.anno.cpg$MAPINFO[ref.anno.cpg$ID==cpg.id]
  
  if(chr.snp!=chr.cpg){tmp.distance=-999}else{
    tmp.distance = abs(bp.snp-bp.cpg)
  }
  return(tmp.distance)
}

# Reload data
load(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/cpg_snp_mapping_pNbeta.RData'))

ls.CpG = ls.CpG %>%
  mutate(.,CHR=gsub('chr','',CHR)) %>%
  mutate(.,CHR=as.numeric(CHR)) %>%
  .[order(.$CHR,decreasing = F),] %>%
  mutate(ID=as.character(ID))

colnames(ls.SNP.102)=c('CHR','BP','RSID')
ls.SNP.102 = ls.SNP.102 %>%
  mutate(.,CHR=gsub('chr','',CHR)) %>%
  mutate(.,CHR=as.numeric(CHR)) %>%
  .[order(.$CHR,decreasing = F),] %>%
  mutate(RSID=as.character(RSID)) %>%
  mutate(is.MHC = if_else(BP>25000000&BP<35000000&CHR==6,'Yes','No'))

p.mat = p.mat %>% column_to_rownames(var="CpG") 
colnames(p.mat)=strsplit(colnames(p.mat),split = '_') %>% unlist %>% .[grep('^rs',.)]
p.mat[p.mat==0]=1e-320  # Recover extremely low p-values to system threshold
p.mat[p.mat>0.05/102]=NA
p.mat.new = -log10(p.mat) %>%
  .[ls.CpG$ID,] %>%
  .[,ls.SNP.102$RSID]

# Transform matrix to long-format data
ids.input = expand.grid(dimnames(p.mat),stringsAsFactors = F)
colnames(ids.input) = c('CpG','SNP')
# Calc distance
distance.long = pbapply(ids.input,FUN=cal_distance,MARGIN = 1,
                      ref.anno.snp=ls.SNP.102,ref.anno.cpg=ls.CpG)
distance.long = data.frame(ids.input,distance.long)
# Transform results back to matrix
distance.mat = matrix(distance.long[,3],ncol=102,byrow = F)
colnames(distance.mat)=colnames(p.mat)
rownames(distance.mat)=rownames(p.mat)
distance.mat[distance.mat==-999]=NA

distance.mat.clean = distance.mat
distance.mat.clean[is.na(p.mat)]=NA

##### Summarise distance
# N sig CpG
colSums(!is.na(p.mat))[ls.SNP.102$RSID[ls.SNP.102$is.MHC=='Yes']]
colSums(!is.na(p.mat))[ls.SNP.102$RSID[ls.SNP.102$is.MHC=='No']]

# Distance
distance.summary.trans = 
  colSums(distance.mat.clean>1000000,na.rm =T)[ls.SNP.102$RSID[ls.SNP.102$is.MHC=='No']]/
  colSums(!is.na(distance.mat.clean))[ls.SNP.102$RSID[ls.SNP.102$is.MHC=='No']]
distance.summary.trans = distance.summary.trans[!is.na(distance.mat.clean)>0]

```


------------------------------------------------------------------------

## Mendelian Randomisation: CpG -> Brain cortical structure

------------------------------------------------------------------------

### Methods

#### Datasets

-   Exposure: mQTL data from GoDMC (N = 20,396). Cohorts that overlap with PGC29 were removed.

-   Outcome: Cortical thickness and cortical surface area (UKB, N\~=40k)

    
#### Instruments

```{r Load info for genetic instruments DNAm to brain,echo=FALSE}
# Load summary info for GoDMC instruments
summary.instrument=readRDS(here::here('MR_meth_MDD/data/mQTL/GoDMC.instrument.rds'))

# Load EWAS summary stats
ewas.summstat.tophitPRS=fread(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/meta-pgrs-mdd/mdd_SNPCH_prs_5e_08/mdd_SNPCH_prs_5e_08.metal.out1.tbl'),
                              header=T,stringsAsFactors=F)
ewas.summstat.tophitPRS = ewas.summstat.tophitPRS %>%
  mutate(p.adj=p.adjust(`P-value`,method = 'bonferroni'))
n.sig.cpg=sum(ewas.summstat.tophitPRS$p.adj<0.05)
ls.cpg.ewas.sig = filter(ewas.summstat.tophitPRS,p.adj<0.05)

# Find suitable CpGs for MR
ls.cpg.sig_instru=ls.cpg.ewas.sig[ls.cpg.ewas.sig$MarkerName %in% summary.instrument$cpg[summary.instrument$n.5e_08>30],]

```

-   In the EWAS of MDD PRS (pT = 5e-8), a total of `r n.sig.cpg` CpGs were significant after Bonferroni correction.

-   `r nrow(ls.cpg.sig_instru)` had more than 30 genetic instruments available.

-   `r length(list.files(here::here('MR_meth_MDD/data/mQTL/mQTL_forMR/')))` CpGs left after 'clumping' (window = 3Mb, r=0.1) in the MHC region.

-   Finally, 20 CpGs with \>=5 genetic instruments after data harmonisation entered MR.


#### MR methods

-   Analyses: IVW, Weighted-median, MR-Egger

-   Additional test: [MR Steiger directionary test](http://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1007081).

-   Package: [TwoSampleMR](https://mrcieu.github.io/TwoSampleMR/)


### Results {.tabset}

**25** CpGs tested:

```{r Load MR results DNAm to brain and make figures, echo=FALSE}
ls.measure = c('TotalSurface','MeanThk','TotalVol','gFA','gMD','gFA_TR','gMD_TR')

# Load results
res = as.list(paste0('/gpfs/igmmfs01/eddie/GenScotDepression/shen/ActiveProject/Genetic/MR_meth_MDD/result/GS_MR_DNAm_to_Brain/Summary_DNAm_to_',ls.measure,'.csv')) %>% 
  lapply(.,FUN=read.csv,header=T,sep='\t',stringsAsFactors = F)
names(res)=ls.measure

# Make figures
#system('mkdir Figs/MR_DNAm_to_brain')

MR_fig <- function(res.tmp){
  dat.fig = res.tmp %>%
  dplyr::rename(Beta=b,SE=se,Method=method) %>%
  .[order(.$pval,decreasing = T),] %>%
  mutate(ord=1:nrow(.)) %>%
  filter(.,nsnp>5)
  
  target.fig.p =
  ggplot(dat.fig, aes(x=reorder(exposure,ord), y=-log10(pval), color=Method)) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  scale_x_discrete(position='top')+
  geom_hline(yintercept=0,color = "black", size=0.3)+
  geom_hline(yintercept=-log10(0.05),color = "red",linetype='dashed', size=0.3)+
  coord_flip()+
  ylab('P-value for MR')+
  xlab('CpG')
  
  target.fig.beta = 
  ggplot(dat.fig, aes(x=reorder(exposure,ord), y=Beta, color=Method)) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2) +
  geom_errorbar(aes(ymin=Beta-SE, ymax=Beta+SE), width=.2,
                 position=position_dodge(.1)) +
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  scale_x_discrete(position='top')+
  geom_hline(yintercept=0,color = "black", size=0.3)+
  coord_flip()+
  ylab('Beta for MR')+
  xlab('CpG')
  
  tmp.fig.name.p = paste0('MR_meth_MDD/Figs/MR_DNAm_to_brain/Res_pval_DNAm_to_',names(res.tmp),'.png')
  ggsave(file=here::here(tmp.fig.name.p),
       plot=target.fig.p,device='png',
       dpi = 300, width = 8, height = 6, units = 'in')
  
  tmp.fig.name.beta = paste0('MR_meth_MDD/Figs/MR_DNAm_to_brain/Res_beta_DNAm_to_',names(res.tmp),'.png')
  ggsave(file=here::here(tmp.fig.name.beta),
       plot=target.fig.beta,device='png',
       dpi = 300, width = 8, height = 5, units = 'in')
  
  target.fig = target.fig.beta+target.fig.p & theme(legend.position = "bottom")
  return(target.fig)
}

figs.MR = res %>%
  lapply(.,FUN = MR_fig)
names(figs.MR)=ls.measure

```

#### Results: DNAm -> Surface area

```{r DNAm to SA, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$GMsa
```

#### Results: DNAm -> Cortical thickness

```{r DNAm to thk, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$GMthk
```

#### Results: DNAm -> Cortical volume

```{r DNAm to vol, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$GMvol
```

#### Results: DNAm -> gFA

```{r DNAm to gFA, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$WMgFA
```

#### Results: DNAm -> gMD

```{r DNAm to gMD, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$WMgMD
```

#### Results: DNAm -> gFA - TR

```{r DNAm to gFA-TR, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$WMgFA_TR
```

#### Results: DNAm -> gMD - TR

```{r DNAm to gMD-TR, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
figs.MR$WMgMD_TR
```


#### Results: DNAm -> brain measures (IVW)

```{r DNAm to brain IVW results, warning=FALSE, fig.align = 'center',fig.width=15,fig.height=5}

reorg_fornemat <- function(tmp.res,targetmethod,tmp.trait,pval_col){
  new.res = tmp.res[[tmp.trait]] %>%
    mutate(.,outcome=tmp.trait,p.adj=p.adjust(get(pval_col),method='bonferroni')) %>%
    filter(.,method==targetmethod) 
}

ivw.res = as.list(names(res)) %>%
  lapply(.,reorg_fornemat,tmp.res=res,
         targetmethod='Inverse variance weighted',pval_col='pval') %>%
  bind_rows %>%
  mutate(log.p.val=-log10(pval)) 

egger.res = as.list(names(res)) %>%
  lapply(.,reorg_fornemat,tmp.res=res,
         targetmethod='MR Egger',pval_col='pval') %>%
  bind_rows %>%
  mutate(log.p.val=-log10(pval)) %>%
  mutate(p.adj=pval)

wm.res = as.list(names(res)) %>%
  lapply(.,reorg_fornemat,tmp.res=res,
         targetmethod='Weighted median',pval_col='pval') %>%
  bind_rows %>%
  mutate(log.p.val=-log10(pval)) 

ivw.res$outcome = recode(ivw.res$outcome,
                         GMsa = 'Surface area',
                         GMthk = 'Cortical thickness',
                         GMvol = 'Cortical volume',
                         WMgMD = 'global MD',
                         WMgFA_TR = 'gFA in\nthalamic radiation',
                         WMgMD_TR = 'gFA in\nthalamic radiation',
                         WMFA_ATR = 'FA in anterior\nthalamic radiation',
                         WMMD_ATR = 'MD in anterior\nthalamic radiation')

egger.res$outcome = recode(egger.res$outcome,
                         GMsa = 'Surface area',
                         GMthk = 'Cortical thickness',
                         GMvol = 'Cortical volume',
                         WMgMD = 'global MD',
                         WMgFA_TR = 'gFA in\nthalamic radiation',
                         WMgMD_TR = 'gFA in\nthalamic radiation',
                         WMFA_ATR = 'FA in anterior\nthalamic radiation',
                         WMMD_ATR = 'MD in anterior\nthalamic radiation')

wm.res$outcome = recode(wm.res$outcome,
                         GMsa = 'Surface area',
                         GMthk = 'Cortical thickness',
                         GMvol = 'Cortical volume',
                         WMgMD = 'global MD',
                         WMgFA_TR = 'gFA in\nthalamic radiation',
                         WMgMD_TR = 'gFA in\nthalamic radiation',
                         WMFA_ATR = 'FA in anterior\nthalamic radiation',
                         WMMD_ATR = 'MD in anterior\nthalamic radiation')


# Prep data for graph 

fig.1=circular_graph_mr(target.res = ivw.res)
fig.2=circular_graph_mr(target.res = egger.res)
fig.3=circular_graph_mr(target.res = wm.res)

fig.total = ggarrange(fig.1,fig.2,fig.3,ncol=3,
                      labels = c('IVW','MR Egger','Weighted-median'),common.legend = T)

ggsave(fig.total,device = 'png',height=15,width = 40,units = 'cm',dpi=300,
       filename = here::here('MR_meth_MDD/Figs/MR_DNAm_to_brain/MR_res.png'))
fig.total

```



------------------------------------------------------------------------

## Mendelian Randomisation: CpG -> MDD

------------------------------------------------------------------------

### Methods

#### Datasets

-   Exposure: mQTL data from GoDMC (N = 20,396). Cohorts that overlap with PGC29 were removed.

-   Outcome: MDD meta-GWAS (PGC + UKBnoGS + 23andMe, N\~=800k)

    
#### Instruments

```{r Load info for genetic instruments,echo=FALSE}
# Load summary info for GoDMC instruments
summary.instrument=readRDS(here::here('MR_meth_MDD/data/mQTL/GoDMC.instrument.rds'))

# Load EWAS summary stats
ewas.summstat.tophitPRS=fread(here::here('MR_meth_MDD/result/EWAS_MDDprs_fromKathryn/meta-pgrs-mdd/mdd_SNPCH_prs_5e_08/mdd_SNPCH_prs_5e_08.metal.out1.tbl'),
                              header=T,stringsAsFactors=F)
ewas.summstat.tophitPRS = ewas.summstat.tophitPRS %>%
  mutate(p.adj=p.adjust(`P-value`,method = 'bonferroni'))
n.sig.cpg=sum(ewas.summstat.tophitPRS$p.adj<0.05)
ls.cpg.ewas.sig = filter(ewas.summstat.tophitPRS,p.adj<0.05)

# Find suitable CpGs for MR
ls.cpg.sig_instru=ls.cpg.ewas.sig[ls.cpg.ewas.sig$MarkerName %in% summary.instrument$cpg[summary.instrument$n.5e_08>30],]

```

-   In the EWAS of MDD PRS (pT = 5e-8), a total of `r n.sig.cpg` CpGs were significant after Bonferroni correction.

-   `r nrow(ls.cpg.sig_instru)` had more than 30 genetic instruments available.

-   `r length(list.files(here::here('MR_meth_MDD/data/mQTL/mQTL_forMR/')))` CpGs left after 'clumping' (window = 250kb, r=0.1)

-   Finally, 25 CpGs with \>=5 genetic instruments after data harmonisation entered MR.


#### MR methods

-   Analyses: IVW, Weighted-median, MR-Egger

-   Additional test: [MR Steiger directionary test](http://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1007081).

-   Package: [TwoSampleMR](https://mrcieu.github.io/TwoSampleMR/)

------------------------------------------------------------------------

### Results

**25** CpGs tested:

```{r Load MR results, echo=FALSE}
res = read.csv(here::here('MR_meth_MDD/script/ANALY.MR/DNAm_to_MDD/Summary_MR.csv'),header=T,sep='\t',stringsAsFactors = F)

```

#### Results for IVW, MR-Egger and Weighted median

```{r Summary of MR results, warning=FALSE, fig.align = 'center',fig.width=10,fig.height=5}
dat.fig = res %>%
  mutate(ord=1:nrow(.))
  
fig=
  ggplot(dat.fig, aes(x=reorder(exposure,ord), y=-log10(pval), color=method)) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  scale_x_discrete(position='top')+
  geom_hline(yintercept=0,color = "black", size=0.3)+
  geom_hline(yintercept=-log10(0.05),color = "red",linetype='dashed', size=0.3)+
  coord_flip()+
  ylab('P-value for MR')+
  xlab('CpG')
fig
```

  
#### Quality tests for MR {.tabset}

-   MR Steiger directionality: All MR tests were in the correct direction and p values for directionality < 1.61e-135

##### Quality test 1: Egger intercept

```{r MR intercept, message=FALSE, warning=FALSE, fig.align = 'center',fig.width=8,fig.height=4}
dat.fig = res %>%
  filter(method=='MR Egger') %>%
  mutate(ord=1:nrow(.)) 
  
fig=
  ggplot(dat.fig, aes(x=reorder(exposure,ord), y=-log10(pval.1))) + 
  geom_point(color='tomato',position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  scale_x_discrete(position='top')+
  geom_hline(yintercept=0,color = "black", size=0.3)+
  geom_hline(yintercept=-log10(0.05),color = "red",linetype='dashed', size=0.3)+
  coord_flip()+
  ggtitle('MR Egger intercept')+
  ylab('P-value for MR Egger intercept')+
  xlab('CpG')
fig
```
  

##### Quality test 2: Q index (heterogeneity)

```{r Q index, warning=FALSE,message=FALSE, fig.align = 'center',fig.width=8,fig.height=4}
dat.fig = res %>%
  filter(method=='Inverse variance weighted') %>%
  mutate(ord=1:nrow(.)) 
  
fig=
  ggplot(dat.fig, aes(x=reorder(exposure,ord), y=-log10(Q_pval))) + 
  geom_point(color='tomato',position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  scale_x_discrete(position='top')+
  geom_hline(yintercept=0,color = "black", size=0.3)+
  geom_hline(yintercept=-log10(0.05),color = "red",linetype='dashed', size=0.3)+
  coord_flip()+
  ggtitle('Q test (heterogeneity)')+
  ylab('P-value for Q statistics')+
  xlab('CpG')
fig
```
  

##### Quality test 3: MR results and Egger intercept (horizontal pleiotropy)

```{r MR and Egger intercept,warning=F, message=F,fig.width=12,fig.height=4}
dat.fig = res 

fig=
  ggplot(dat.fig, aes(x=-log10(pval.1), y=-log10(pval))) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  geom_smooth(method=lm , color="red", se=TRUE)+
  facet_wrap(~method,dir='h', scales = "free_y") +
  ylab('P-value for MR')+
  xlab('P-value for Egger intercept')

fig

```

##### Quality test 4: MR results and Q statistics (heterogeneity)

```{r MR and Q, message=F,warning=F,fig.width=12,fig.height=4}
dat.fig = res 

fig=
  ggplot(dat.fig, aes(x=-log10(Q_pval), y=-log10(pval))) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  geom_smooth(method=lm , color="red", se=TRUE)+
  facet_wrap(~method,dir='h', scales = "free_y") +
  ylab('P-value for MR')+
  xlab('P-value for Q test')

fig

```


##### Quality test 5: MR results and instrumental strength

```{r MR and instrumental strength, message=F,fig.width=12,fig.height=4}
dat.fig = res 

fig=
  ggplot(dat.fig, aes(x=snp_r2.exposure, y=-log10(pval))) + 
  geom_point(position=position_dodge(width = 0.1), stat="identity", size=2) +
  theme(
    axis.line.x = element_line(size=0.5),
    axis.text=element_text(size=10), axis.title=element_text(size=11),
    plot.title = element_text(lineheight=1, face="bold", vjust=1, hjust=0.5,size=9),
    strip.text = element_text(size=8),
    plot.margin=unit(c(1,1,1,3),'mm')) +
  geom_smooth(method=lm , color="red", se=TRUE)+
  facet_wrap(~method,dir='h', scales = "free_y") +
  ylab('P-value for MR')+
  xlab('SNP R2 for exposure')

fig

```


#### MR - Summary

-   **All** CpGs were significant for \>= 1 MR method

-   **20** significant for \>=2 MR methods

-   **9** significant for all three MR methods + **6** CpGs insig for IVW and Weight median and MR-Egger intercept insignificant = **15** valid causal effects from CpG to MDD

-   Positions of these CpGs


```{r,warning=FALSE,message=FALSE,fig.width=13,fig.height=7}
# Find CpGs sig for all three methods
# ls.cpg.3mr = res %>%
#   group_by(exposure) %>%
#   count(pval<0.05) %>%
#   filter(`pval < 0.05`==T, n == 3)
# # CpGs sig for IVW and WM
# ls.cpg.2mr.ivw_wm = res %>%
#   filter(method!='MR Egger') %>%
#   group_by(exposure) %>%
#   count(pval<0.05) %>%
#   filter(`pval < 0.05`==T, n == 2)
# # CpGs insig for MR Egger intercept
# ls.cpg.mregger_intercept_null = res %>%
#   filter(method=='MR Egger') %>%
#   filter(pval.1>0.05)
# # CpGs sig for IVW and WM and insig for MR Egger intercept
# ls.cpg.2mr.valid = ls.cpg.2mr.ivw_wm %>%
#   filter(exposure %in% ls.cpg.mregger_intercept_null$exposure)
# # Final list: 3 methods + 2 methods (ivw+wm+Egger intercept null)
# ls.cpg.valid = c(as.character(ls.cpg.3mr$exposure),
#                  as.character(ls.cpg.2mr.valid$exposure)) %>% unique
# 
# m_plot(dat=fig.dat.pT.5e_08,chr="CHR", bp="MAPINFO", snp="CpG", p="P.value",
#         add_category_name=F,fig_size=c(26,13),tophits_annot=F,y_lim=c(0,120),
#         man_annot=ls.cpg.valid)
```

